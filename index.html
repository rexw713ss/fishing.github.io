<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·æ´‹æ·¨åŒ–å¤§ä½œæˆ° v5.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Noto+Sans+TC:wght@500;700&display=swap');

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Noto Sans TC', 'Fredoka One', sans-serif; background-color: #333; user-select: none; touch-action: none; }

        #game-container {
            position: relative; width: 100%; height: 100%; max-width: 1024px; margin: 0 auto;
            background: linear-gradient(to bottom, #87CEEB 20%, #006994 20%, #001e36 100%);
            overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: background 0.5s;
        }

        /* ğŸ«§ èƒŒæ™¯æ°£æ³¡ç‰¹æ•ˆ */
        .bubble {
            position: absolute; bottom: -50px; background: rgba(255, 255, 255, 0.2);
            border-radius: 50%; pointer-events: none; animation: rise linear infinite;
        }
        @keyframes rise { 0% { transform: translateY(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-100vh); opacity: 0; } }

        /* ç‰¹æ•ˆ */
        .fever-mode { background: linear-gradient(to bottom, #FFD700 20%, #FF8C00 50%, #FF4500 100%) !important; }
        .shake-effect { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-5px, 0, 0); } 20%, 80% { transform: translate3d(5px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-5px, 0, 0); } 40%, 60% { transform: translate3d(5px, 0, 0); } }

        /* UI */
        .ui-layer {
            position: absolute; top: 20px; left: 20px; right: 20px; z-index: 100;
            display: flex; justify-content: space-between; pointer-events: none;
            color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        .score-box, .timer-box {
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 20px;
            font-size: 1.2rem; border: 3px solid #fff;
        }
        #combo-box {
            position: absolute; top: 80px; left: 20px; font-size: 1.5rem; color: #FFEB3B; font-weight: bold;
            opacity: 0; transition: opacity 0.3s; text-shadow: 2px 2px 0 #000;
        }
        .combo-active { opacity: 1 !important; animation: popIn 0.3s; }

        /* ğŸ”¥ èƒ½é‡æ¢ (å¤§çµ•æ‹›) */
        .energy-container {
            position: absolute; top: 80px; right: 20px; width: 150px; height: 20px;
            background: rgba(0,0,0,0.5); border: 2px solid white; border-radius: 10px; overflow: hidden;
        }
        #energy-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #00C9FF, #92FE9D); transition: width 0.3s; }
        
        /* ğŸš€ å¤§çµ•æ‹›æŒ‰éˆ• (æµ®å‹•) */
        #btn-ult {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%) scale(0);
            width: 100px; height: 100px; border-radius: 50%; border: 4px solid #fff;
            background: radial-gradient(circle, #FF4081, #C51162); color: white;
            font-size: 1.5rem; font-weight: bold; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 20px #FF4081; z-index: 160; cursor: pointer; transition: transform 0.3s;
            pointer-events: auto; animation: pulseUlt 1s infinite;
        }
        .ult-ready { transform: translateX(-50%) scale(1) !important; }
        @keyframes pulseUlt { 0% { box-shadow: 0 0 0 0 rgba(255, 64, 129, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 64, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 64, 129, 0); } }

        /* éŠæˆ²ç‰©ä»¶ */
        #boat { position: absolute; top: 15%; left: 50%; width: 120px; height: 80px; transform: translate(-50%, -50%); z-index: 50; display: flex; justify-content: center; align-items: center; font-size: 80px; }
        #player-avatar { position: absolute; top: -40px; left: 30px; width: 50px; height: 50px; background-image: url('figs/earth.png'); background-size: contain; background-repeat: no-repeat; }
        #fishing-line { position: absolute; top: 20%; left: 50%; width: 4px; height: 0px; background-color: white; z-index: 40; transform: translateX(-50%); }
        #hook { position: absolute; top: 20%; left: 50%; width: 40px; height: 40px; transform: translate(-50%, 0); z-index: 40; font-size: 35px; text-align: center; line-height: 40px; }
        
        /* æšˆçœ©æç¤º */
        #stun-msg {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; color: red; font-weight: bold; text-shadow: 2px 2px 0 white;
            z-index: 180; animation: shake 0.2s infinite; display: none;
        }

        .sea-item {
            position: absolute; width: 70px; height: 70px; font-size: 50px;
            display: flex; justify-content: center; align-items: center; z-index: 30;
            will-change: transform, left, top; /* å„ªåŒ–æ•ˆèƒ½ */
        }

        /* æ§åˆ¶æŒ‰éˆ• */
        .controls-layer { position: absolute; bottom: 20px; left: 0; width: 100%; height: 80px; z-index: 150; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; box-sizing: border-box; pointer-events: auto; }
        .control-btn { width: 80px; height: 80px; background: rgba(255, 255, 255, 0.3); border: 3px solid white; border-radius: 50%; color: white; font-size: 40px; display: flex; justify-content: center; align-items: center; cursor: pointer; backdrop-filter: blur(5px); -webkit-tap-highlight-color: transparent; }
        .control-btn:active, .control-btn.pressed { background: rgba(255, 255, 255, 0.6); transform: scale(0.9); }
        #btn-fish { width: 100px; height: 100px; background: rgba(255, 107, 107, 0.8); border-color: #ffcccc; font-size: 50px; margin-bottom: 20px; }

        /* æ’è¡Œæ¦œèˆ‡ç•«é¢ */
        .rank-list { list-style: none; padding: 0; margin: 10px 0; width: 100%; max-width: 300px; background: rgba(255,255,255,0.1); border-radius: 10px; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 15px; border-bottom: 1px solid rgba(255,255,255,0.2); font-size: 1.1rem; }
        .rank-item:nth-child(1) { color: #FFD700; font-weight: bold; } .rank-item:nth-child(2) { color: #C0C0C0; } .rank-item:nth-child(3) { color: #CD7F32; }
        .input-group { margin: 15px 0; display: flex; gap: 10px; justify-content: center; }
        #player-name { padding: 10px; border-radius: 10px; border: none; font-size: 1.2rem; width: 150px; text-align: center; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: rgba(0,0,0,0.9); color: white; z-index: 200; }
        .screen.active { display: flex; animation: fadeIn 0.5s; }
        .btn { background: #FF6B6B; color: white; border: none; padding: 15px 40px; font-size: 1.5rem; border-radius: 50px; cursor: pointer; margin-top: 20px; font-family: 'Fredoka One'; box-shadow: 0 5px 0 #D32F2F; }
        .btn:active { transform: translateY(5px); box-shadow: none; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        .score-pop { position: absolute; font-weight: bold; font-size: 2rem; animation: floatUp 1s forwards; pointer-events: none; z-index: 160; text-shadow: 2px 2px 0 #000; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.5); opacity: 0; } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }

    </style>
</head>
<body>

<div id="game-container">
    <div id="bubbles-layer"></div>
    
    <div class="ui-layer">
        <div class="score-box">åˆ†æ•¸: <span id="score">0</span></div>
        <div class="timer-box">æ™‚é–“: <span id="time">60</span></div>
    </div>
    
    <div class="energy-container">
        <div id="energy-bar"></div>
    </div>
    <div id="combo-box">COMBO x<span id="combo-count">0</span> ğŸ”¥</div>
    <div id="stun-msg">æšˆçœ©! ğŸ˜µ</div>

    <div id="fishing-line"></div>
    <div id="hook">âš“</div>
    <div id="boat">â›µ<div id="player-avatar"></div></div>
    <div id="sea-area"></div>

    <div id="btn-ult" onclick="activateUlt()">BOOM!</div>

    <div class="controls-layer" id="controls">
        <div class="control-btn" id="btn-left">â¬…ï¸</div>
        <div class="control-btn" id="btn-fish">ğŸ£</div>
        <div class="control-btn" id="btn-right">â¡ï¸</div>
    </div>

    <div id="screen-start" class="screen active">
        <h1>æµ·æ´‹æ·¨åŒ– v5.0</h1>
        <p style="font-size: 1.1rem; line-height: 1.6;">
            ğŸŒŠ <b>æ³¢æµªæ¨¡å¼</b>: åƒåœ¾æœƒä¸Šä¸‹æµ®å‹•ï¼Œçœ‹æº–å†æŠ“ï¼<br>
            âš¡ <b>é›†æ°£å¤§æ‹›</b>: æŠ“åƒåœ¾é›†æ°£ï¼ŒæŒ‰ <span style="color:#FF4081">BOOM</span> æ¸…å…¨å ´ï¼<br>
            ğŸ¦ˆ <b>å°å¿ƒé¯Šé­š</b>: è¢«å’¬åˆ°æœƒæšˆçœ©ï¼
        </p>
        <button class="btn" onclick="startGame()">é–‹å§‹å‡ºèˆª</button>
        <h3 style="margin-top: 15px; color:#FFD700; font-size: 1.2rem;">ğŸ† æ¦®è­½æ¦œ</h3>
        <ul id="start-leaderboard" class="rank-list"></ul>
    </div>

    <div id="screen-end" class="screen">
        <h1>æ™‚é–“åˆ°ï¼</h1>
        <p style="font-size: 1.5rem; margin: 10px 0;">æœ€çµ‚åˆ†æ•¸: <span id="final-score" style="color:#FFEB3B; font-size:2.5rem;">0</span></p>
        <div id="input-section" class="input-group">
            <input type="text" id="player-name" placeholder="è¼¸å…¥ä½ çš„åå­—" maxlength="8">
            <button class="btn" style="margin:0; padding: 10px 20px; font-size:1rem;" onclick="submitScore()">ç™»è¨˜</button>
        </div>
        <div id="leaderboard-section" style="display:none; width: 100%; display: flex; flex-direction: column; align-items: center;">
            <h3 style="color:#FFD700; margin: 10px 0;">ğŸ† æœ¬æ©Ÿæ’è¡Œæ¦œ ğŸ†</h3>
            <ul id="end-leaderboard" class="rank-list"></ul>
            <button class="btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

</div>

<script>
    /* --- ğŸ”Š éŸ³æ•ˆç³»çµ± --- */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        
        if (type === 'catch_good') { 
            osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1200, now+0.1);
            gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.3);
            osc.start(now); osc.stop(now+0.3);
        } else if (type === 'ult') { // å¤§çµ•æ‹›éŸ³æ•ˆ
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(50, now+0.5);
            gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0.01, now+0.5);
            osc.start(now); osc.stop(now+0.5);
        } else if (type === 'catch_bad') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now+0.3);
            gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0.01, now+0.3);
            osc.start(now); osc.stop(now+0.3);
        } else if (type === 'shoot') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(100, now+0.2);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now+0.2);
            osc.start(now); osc.stop(now+0.2);
        } else if (type === 'shark') {
            osc.type = 'square'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(80, now+0.1);
            gain.gain.setValueAtTime(0.4, now); gain.gain.linearRampToValueAtTime(0.01, now+0.4);
            osc.start(now); osc.stop(now+0.4);
        } else if (type === 'fever') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(1200, now+0.4);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.6);
            osc.start(now); osc.stop(now+0.6);
        }
    }

    /* --- ğŸ® åƒæ•¸ --- */
    const gameDuration = 60; const boatSpeed = 1.0; let baseSpawnRate = 800;
    const items = [
        { type: 'trash', content: 'figs/bottle.png', isImage: true, score: 100, speed: 2, wave: 3 }, // wave: æ³¢æµªå¹…åº¦
        { type: 'trash', content: 'ğŸ‘¢', isImage: false, score: 150, speed: 2.5, wave: 2 },
        { type: 'trash', content: 'ğŸ¥¡', isImage: false, score: 120, speed: 3, wave: 4 },
        { type: 'trash', content: 'ğŸ’', isImage: false, score: 500, speed: 5, wave: 1 }, 
        { type: 'powerup', content: 'â°', isImage: false, score: 0, speed: 4, wave: 2, effect: 'time' },
        { type: 'fish', content: 'ğŸŸ', isImage: false, score: -50, speed: 4, wave: 2 },
        { type: 'fish', content: 'ğŸ¢', isImage: false, score: -100, speed: 3, wave: 1 },
        { type: 'shark', content: 'ğŸ¦ˆ', isImage: false, score: -200, speed: 6, wave: 0, effect: 'stun' }
    ];

    /* --- è®Šæ•¸ --- */
    let score = 0, combo = 0, energy = 0, isFever = false, isStunned = false, timeLeft = gameDuration, isPlaying = false;
    let gameLoopId, spawnLoopId, timerLoopId, bubbleLoopId;
    let boatPos = 50, moveDirection = 0, hookState = 'idle', hookY = 20, hookX = 50, caughtItem = null;

    // DOM
    const boatEl = document.getElementById('boat'), lineEl = document.getElementById('fishing-line'), hookEl = document.getElementById('hook');
    const seaArea = document.getElementById('sea-area'), container = document.getElementById('game-container');
    const comboBox = document.getElementById('combo-box'), comboCountEl = document.getElementById('combo-count');
    const energyBar = document.getElementById('energy-bar'), btnUlt = document.getElementById('btn-ult'), stunMsg = document.getElementById('stun-msg');
    const btnLeft = document.getElementById('btn-left'), btnRight = document.getElementById('btn-right'), btnFish = document.getElementById('btn-fish');
    const inputSection = document.getElementById('input-section'), leaderboardSection = document.getElementById('leaderboard-section');

    /* --- æ§åˆ¶ --- */
    function setupBtn(btn, dir) {
        const action = (e) => { if(e.cancelable)e.preventDefault(); if(!isStunned){moveDirection=dir;btn.classList.add('pressed');}};
        const endAction = (e) => { if(e.cancelable)e.preventDefault(); if(moveDirection===dir)moveDirection=0; btn.classList.remove('pressed');};
        btn.addEventListener('touchstart', action); btn.addEventListener('mousedown', action);
        btn.addEventListener('touchend', endAction); btn.addEventListener('mouseup', endAction); btn.addEventListener('mouseleave', endAction);
    }
    setupBtn(btnLeft, -1); setupBtn(btnRight, 1);
    function triggerFish(e) {
        if(e && e.cancelable) e.preventDefault();
        if (!isPlaying || hookState !== 'idle' || isStunned) return;
        hookState = 'down'; playSound('shoot'); btnFish.classList.add('pressed'); setTimeout(()=>btnFish.classList.remove('pressed'), 200);
    }
    btnFish.addEventListener('touchstart', triggerFish); btnFish.addEventListener('mousedown', triggerFish);
    document.addEventListener('keydown', (e)=>{ if(isStunned)return; if(e.key==='ArrowLeft')moveDirection=-1; if(e.key==='ArrowRight')moveDirection=1; if(e.key===' '||e.key==='ArrowDown')triggerFish(); });
    document.addEventListener('keyup', (e)=>{ if((e.key==='ArrowLeft'&&moveDirection===-1)||(e.key==='ArrowRight'&&moveDirection===1))moveDirection=0; });

    /* --- ğŸŒŠ æ°£æ³¡ç‰¹æ•ˆ --- */
    function createBubble() {
        if(!isPlaying) return;
        const b = document.createElement('div'); b.classList.add('bubble');
        const size = Math.random() * 20 + 10;
        b.style.width = `${size}px`; b.style.height = `${size}px`;
        b.style.left = `${Math.random() * 100}%`;
        b.style.animationDuration = `${Math.random() * 5 + 5}s`;
        document.getElementById('bubbles-layer').appendChild(b);
        setTimeout(()=>b.remove(), 10000);
    }

    /* --- ğŸš€ éŠæˆ²ä¸»è¿´åœˆ --- */
    function gameLoop() {
        if (!isPlaying) return;

        if (moveDirection !== 0 && !isStunned) {
            boatPos += moveDirection * boatSpeed;
            if (boatPos < 5) boatPos = 5; if (boatPos > 95) boatPos = 95;
            boatEl.style.left = boatPos + '%';
        }

        if (hookState === 'idle') {
            hookX = boatPos; lineEl.style.left = boatPos + '%'; hookEl.style.left = boatPos + '%';
        } else if (hookState === 'down') {
            hookY += 1.5; if (hookY > 95) hookState = 'up';
        } else if (hookState === 'up') {
            hookY -= 1.5;
            if (hookY <= 20) {
                hookY = 20; hookState = 'idle';
                if (caughtItem) { processCatch(caughtItem); caughtItem.element.remove(); caughtItem = null; hookEl.innerText = 'âš“'; }
            }
        }
        hookEl.style.top = hookY + '%'; lineEl.style.height = (hookY - 20) + '%';
        if (hookState === 'down' && !caughtItem) checkCollision();
        moveItems();
        requestAnimationFrame(gameLoop);
    }

    function checkCollision() {
        const hookRect = hookEl.getBoundingClientRect();
        const itemsEls = document.querySelectorAll('.sea-item');
        itemsEls.forEach(el => {
            const itemRect = el.getBoundingClientRect();
            if (hookRect.left < itemRect.right && hookRect.right > itemRect.left && hookRect.bottom > itemRect.top && hookRect.top < itemRect.bottom) {
                hookState = 'up'; caughtItem = { element: el, data: JSON.parse(el.dataset.info) };
                el.style.position = 'fixed'; hookEl.innerText = ''; el.style.top = '0'; el.style.left = '0';
                el.style.transform = 'translate(-50%, 0)'; hookEl.appendChild(el); 
            }
        });
    }

    /* --- ç‰©å“ç”Ÿæˆ (å«æ³¢æµªåƒæ•¸) --- */
    function spawnItem() {
        if (!isPlaying) return;
        let itemData; const rand = Math.random();
        if (isFever) { if (rand < 0.8) itemData = items[0]; else itemData = items[3]; }
        else { if (rand < 0.05) itemData = items.find(i=>i.content==='ğŸ¦ˆ'); else if (rand < 0.1) itemData = items.find(i=>i.content==='ğŸ’'); else if (rand < 0.15) itemData = items.find(i=>i.content==='â°'); else itemData = items[Math.floor(Math.random() * items.length)]; }

        const el = document.createElement('div'); el.classList.add('sea-item');
        if(itemData.isImage) { el.style.backgroundImage = `url('${itemData.content}')`; el.style.backgroundSize = 'contain'; el.style.backgroundRepeat = 'no-repeat'; } else { el.innerText = itemData.content; }
        el.dataset.info = JSON.stringify(itemData);
        
        // è¨­å®šåˆå§‹é«˜åº¦ï¼Œä¾›æ³¢æµªè¨ˆç®—ç”¨
        const startTop = Math.random() * 50 + 40;
        el.dataset.startTop = startTop;
        el.style.top = startTop + '%';

        const fromLeft = Math.random() > 0.5;
        el.style.left = fromLeft ? '-10%' : '110%';
        el.dataset.direction = fromLeft ? 1 : -1;
        el.dataset.speed = itemData.speed * (1 + (score/3000));
        el.dataset.wave = itemData.wave; // æ³¢æµªå¼·åº¦
        if (!fromLeft) el.style.transform = 'scaleX(-1)';
        seaArea.appendChild(el);
    }

    /* --- ğŸŒŠ ç§»å‹•ç‰©å“ (åŠ å…¥ Sine Wave) --- */
    function moveItems() {
        const itemsEls = document.querySelectorAll('.sea-item');
        const time = Date.now() / 500; // æ™‚é–“å› å­
        itemsEls.forEach(el => {
            if (el.parentElement === hookEl) return;
            let currentLeft = parseFloat(el.style.left);
            const direction = parseFloat(el.dataset.direction);
            const speed = parseFloat(el.dataset.speed);
            const startTop = parseFloat(el.dataset.startTop);
            const waveAmp = parseFloat(el.dataset.wave);

            // X è»¸ç§»å‹•
            const newLeft = currentLeft + (direction * speed * 0.1); 
            el.style.left = newLeft + '%';
            
            // Y è»¸æ³¢æµªç§»å‹• (Base Top + Sin Wave)
            const newTop = startTop + Math.sin(time + newLeft/10) * waveAmp;
            el.style.top = newTop + '%';

            if (newLeft > 120 || newLeft < -20) el.remove();
        });
    }

    /* --- ğŸ’¥ åˆ†æ•¸/å¤§çµ•æ‹› --- */
    function processCatch(item) {
        const type = item.data.type;
        let points = item.data.score;
        if (type === 'shark') { applyStun(); playSound('shark'); combo=0; hideCombo(); }
        if (type === 'trash' || type === 'powerup') {
            playSound('catch_good'); combo++;
            // å¢åŠ èƒ½é‡
            chargeEnergy(10);
            if (!isFever && combo > 1) points = Math.floor(points * (1 + (combo * 0.1)));
            if (isFever) points *= 2;
            showCombo();
        } else if (type === 'fish' || type === 'shark') {
            if(!isFever) { combo = 0; hideCombo(); }
            playSound('catch_bad'); triggerShake();
        }
        if (item.data.effect === 'time') { timeLeft += 10; showPopup(`+10ç§’`, '#64FFDA'); }
        score += points; document.getElementById('score').innerText = score;
        let color = '#fff', text = points > 0 ? `+${points}` : `${points}`;
        if (type === 'trash') color = '#4CAF50'; if (item.data.content === 'ğŸ’') { color = '#FFD700'; text = `å¯¶è—!`; } if (type === 'fish') color = '#FF5252';
        showPopup(text, color);
    }

    function chargeEnergy(amount) {
        if(isFever) return; // Fever æ™‚ä¸é›†æ°£
        energy += amount;
        if(energy >= 100) {
            energy = 100;
            btnUlt.classList.add('ult-ready');
        }
        energyBar.style.width = energy + '%';
    }

    /* --- ğŸš€ æ–½æ”¾å¤§çµ•æ‹› --- */
    function activateUlt() {
        if(energy < 100) return;
        energy = 0; energyBar.style.width = '0%';
        btnUlt.classList.remove('ult-ready');
        
        playSound('ult');
        triggerShake();
        
        // æ¸…é™¤æ‰€æœ‰åƒåœ¾
        const targets = document.querySelectorAll('.sea-item');
        let count = 0;
        targets.forEach(el => {
            const data = JSON.parse(el.dataset.info);
            if(data.type === 'trash') {
                count++;
                createExplosion(el.style.left, el.style.top);
                el.remove();
                score += (data.score * 1.5); // å¤§çµ•æ‹›åŠ æˆ
            }
        });
        
        document.getElementById('score').innerText = score;
        showPopup(`BOOM! +${Math.floor(count*150)}`, '#FF4081');
        activateFever(); // å¤§çµ•æ‹›ç›´æ¥è§¸ç™¼ Fever
    }

    function createExplosion(x, y) {
        const div = document.createElement('div');
        div.innerText = 'ğŸ’¥'; div.style.position = 'absolute'; div.style.left = x; div.style.top = y; div.style.fontSize = '80px'; div.style.zIndex='100';
        container.appendChild(div); setTimeout(()=>div.remove(), 500);
    }

    function activateFever() {
        if(isFever) return;
        isFever = true; playSound('fever'); container.classList.add('fever-mode');
        clearInterval(spawnLoopId); spawnLoopId = setInterval(spawnItem, 300);
        showPopup("FEVER TIME!!", "#FFD700");
        setTimeout(() => {
            isFever = false; container.classList.remove('fever-mode');
            clearInterval(spawnLoopId); spawnLoopId = setInterval(spawnItem, baseSpawnRate);
        }, 5000);
    }

    /* --- å…¶ä»–åŠŸèƒ½ --- */
    function applyStun() { isStunned = true; hookEl.classList.add('stunned-hook'); stunMsg.style.display = 'block'; moveDirection = 0; setTimeout(() => { isStunned = false; hookEl.classList.remove('stunned-hook'); stunMsg.style.display = 'none'; }, 2000); }
    function showPopup(text, color) { const feedback = document.createElement('div'); feedback.classList.add('score-pop'); feedback.style.left = boatPos + '%'; feedback.style.top = '15%'; feedback.innerText = text; feedback.style.color = color; container.appendChild(feedback); setTimeout(() => feedback.remove(), 1000); }
    function showCombo() { if (combo < 2) return; comboBox.classList.add('combo-active'); comboCountEl.innerText = combo; comboBox.style.animation = 'none'; comboBox.offsetHeight; comboBox.style.animation = null; }
    function hideCombo() { comboBox.classList.remove('combo-active'); }
    function triggerShake() { container.classList.add('shake-effect'); setTimeout(() => { container.classList.remove('shake-effect'); }, 500); }
    function updateTimer() { timeLeft--; document.getElementById('time').innerText = timeLeft; if (timeLeft <= 0) endGame(); }
    
    function startGame() {
        document.getElementById('screen-start').classList.remove('active');
        if (audioCtx.state === 'suspended') audioCtx.resume();
        isPlaying = true; score = 0; combo = 0; energy = 0; timeLeft = gameDuration; isFever = false; isStunned = false;
        document.getElementById('score').innerText = score; document.getElementById('time').innerText = timeLeft; energyBar.style.width = '0%'; btnUlt.classList.remove('ult-ready');
        hideCombo();
        gameLoopId = requestAnimationFrame(gameLoop); spawnLoopId = setInterval(spawnItem, baseSpawnRate); timerLoopId = setInterval(updateTimer, 1000); bubbleLoopId = setInterval(createBubble, 1000);
    }
    function endGame() {
        isPlaying = false; clearInterval(spawnLoopId); clearInterval(timerLoopId); clearInterval(bubbleLoopId); cancelAnimationFrame(gameLoopId);
        document.getElementById('final-score').innerText = score; document.getElementById('screen-end').classList.add('active');
        renderLeaderboard('end-leaderboard'); inputSection.style.display = 'flex'; leaderboardSection.style.display = 'none';
    }
    
    /* --- æ’è¡Œæ¦œ --- */
    const STORAGE_KEY = 'ocean_game_rank_v5';
    function getScores() { return localStorage.getItem(STORAGE_KEY) ? JSON.parse(localStorage.getItem(STORAGE_KEY)) : []; }
    function saveScoreToStorage(name, score) { const scores = getScores(); scores.push({ name: name, score: score }); scores.sort((a, b) => b.score - a.score); localStorage.setItem(STORAGE_KEY, JSON.stringify(scores.slice(0, 5))); }
    function renderLeaderboard(elementId) {
        const listEl = document.getElementById(elementId); listEl.innerHTML = '';
        const scores = getScores();
        if (scores.length === 0) { listEl.innerHTML = '<li style="text-align:center; padding:10px;">å°šç„¡ç´€éŒ„</li>'; return; }
        scores.forEach((s, index) => { let medal = index === 0 ? 'ğŸ¥‡ ' : index === 1 ? 'ğŸ¥ˆ ' : index === 2 ? 'ğŸ¥‰ ' : `${index + 1}. `; const li = document.createElement('li'); li.classList.add('rank-item'); li.innerHTML = `<span class="rank-name">${medal}${s.name}</span><span class="rank-score">${s.score}</span>`; listEl.appendChild(li); });
    }
    function submitScore() { const name = document.getElementById('player-name').value.trim(); if (!name) { alert('è«‹è¼¸å…¥åå­—å–”ï¼'); return; } saveScoreToStorage(name, score); inputSection.style.display = 'none'; leaderboardSection.style.display = 'flex'; renderLeaderboard('end-leaderboard'); }
    renderLeaderboard('start-leaderboard');

</script>
</body>
</html>